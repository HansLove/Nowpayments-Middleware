# Configuration Examples

Complete configuration examples for different environments and use cases.

## Basic Configuration

```typescript
import { NowPaymentsMiddleware } from '@taloon/nowpayments-middleware';

// Simple configuration
NowPaymentsMiddleware.configure({
  apiKey: 'your-nowpayments-api-key',
  email: 'your-email@example.com', // Optional, required for payouts
  password: 'your-password', // Optional, required for payouts
});
```

## Environment-Based Configuration

```typescript
// Development environment
if (process.env.NODE_ENV === 'development') {
  NowPaymentsMiddleware.configure({
    apiKey: process.env.NOWPAYMENTS_API_KEY_DEV!,
    email: process.env.NOWPAYMENTS_EMAIL_DEV,
    password: process.env.NOWPAYMENTS_PASSWORD_DEV,
    baseURL: 'https://api-sandbox.nowpayments.io/v1', // Sandbox URL
    errorHandling: 'direct', // More verbose errors in development
  });
}

// Production environment
if (process.env.NODE_ENV === 'production') {
  NowPaymentsMiddleware.configure({
    apiKey: process.env.NOWPAYMENTS_API_KEY!,
    email: process.env.NOWPAYMENTS_EMAIL,
    password: process.env.NOWPAYMENTS_PASSWORD,
    baseURL: 'https://api.nowpayments.io/v1',
    errorHandling: 'next', // Use Express error handling
  });
}
```

## Error Handling Configuration

### Global Error Handler

Configure a global error handler that applies to all middleware operations:

```typescript
import { NowPaymentsMiddleware, NowPaymentsError } from '@taloon/nowpayments-middleware';

NowPaymentsMiddleware.configure({
  apiKey: process.env.NOWPAYMENTS_API_KEY!,
  email: process.env.NOWPAYMENTS_EMAIL,
  password: process.env.NOWPAYMENTS_PASSWORD,
  onError: async (error, req, res, next) => {
    console.error('Payment error:', {
      path: req.path,
      method: req.method,
      error: error instanceof Error ? error.message : 'Unknown',
    });

    if (error instanceof NowPaymentsError) {
      return res.status(error.statusCode || 500).json({
        success: false,
        code: error.code,
        message: 'Payment service error',
      });
    }

    next(error);
  },
});
```

### Environment-Specific Error Handlers

Different error handling strategies for development and production:

```typescript
const isDevelopment = process.env.NODE_ENV === 'development';

NowPaymentsMiddleware.configure({
  apiKey: process.env.NOWPAYMENTS_API_KEY!,
  onError: async (error, req, res, next) => {
    // Development: detailed errors
    if (isDevelopment) {
      console.error('Detailed error:', error);

      if (error instanceof NowPaymentsError) {
        return res.status(error.statusCode || 500).json({
          success: false,
          code: error.code,
          message: error.message,
          stack: error.stack, // Include stack trace in dev
          originalError: error.originalError,
        });
      }
    }

    // Production: sanitized errors
    if (error instanceof NowPaymentsError) {
      return res.status(error.statusCode || 500).json({
        success: false,
        code: error.code,
        message: 'Payment service error', // Generic message
      });
    }

    next(error);
  },
});
```

### Global + Per-Middleware Handler

Combine global handler with per-middleware overrides:

```typescript
// Global handler for common error handling
NowPaymentsMiddleware.configure({
  apiKey: process.env.NOWPAYMENTS_API_KEY!,
  onError: async (error, req, res, next) => {
    // Log all errors to monitoring service
    monitoringService.logError(error, { path: req.path });

    if (error instanceof NowPaymentsError) {
      return res.status(error.statusCode || 500).json({
        success: false,
        message: 'Payment operation failed',
      });
    }

    next(error);
  },
});

// Per-middleware override for specific needs
app.post('/critical-payment',
  NowPaymentsMiddleware.createPayment({
    mapRequest: (req) => ({ /* ... */ }),
    // Override global handler for critical payments
    onError: async (error, req, res, next) => {
      // Alert on critical payment failures
      await alertService.notifyTeam('Critical payment failed', error);

      return res.status(500).json({
        success: false,
        message: 'Critical payment failed - team notified',
      });
    },
  })
);
```

### Error Handler with Monitoring Integration

```typescript
import * as Sentry from '@sentry/node';
import pino from 'pino';

const logger = pino();

NowPaymentsMiddleware.configure({
  apiKey: process.env.NOWPAYMENTS_API_KEY!,
  onError: async (error, req, res, next) => {
    // Log to structured logger
    logger.error({
      err: error,
      req: {
        method: req.method,
        url: req.url,
        headers: req.headers,
      },
    }, 'NowPayments error occurred');

    // Report to Sentry with context
    if (error instanceof NowPaymentsError) {
      Sentry.captureException(error, {
        tags: {
          source: 'nowpayments-middleware',
          errorCode: error.code,
        },
        contexts: {
          payment: {
            path: req.path,
            method: req.method,
            statusCode: error.statusCode,
          },
        },
      });

      return res.status(error.statusCode || 500).json({
        success: false,
        code: error.code,
        message: process.env.NODE_ENV === 'production'
          ? 'Payment service error'
          : error.message,
      });
    }

    // Non-NowPayments errors: pass to Express
    next(error);
  },
});
```

### Error Handler with Retry Logic

```typescript
NowPaymentsMiddleware.configure({
  apiKey: process.env.NOWPAYMENTS_API_KEY!,
  onError: async (error, req, res, next) => {
    if (error instanceof NowPaymentsNetworkError) {
      // Network errors might be transient
      const retryCount = (req.headers['x-retry-count'] as string) || '0';
      const count = parseInt(retryCount, 10);

      if (count < 3) {
        // Suggest retry to client
        return res.status(503).json({
          success: false,
          code: 'NETWORK_ERROR',
          message: 'Service temporarily unavailable',
          retryable: true,
          retryAfter: Math.pow(2, count) * 1000, // Exponential backoff
        });
      }
    }

    if (error instanceof NowPaymentsError) {
      return res.status(error.statusCode || 500).json({
        success: false,
        code: error.code,
        message: 'Payment operation failed',
        retryable: false,
      });
    }

    next(error);
  },
});
```

## Configuration Interface

```typescript
type ErrorHandler = (
  error: unknown,
  req: express.Request,
  res: express.Response,
  next: express.NextFunction
) => void | Promise<void>;

interface NowPaymentsConfig {
  apiKey: string;                    // Required: Your NowPayments API key
  email?: string;                    // Optional: Email for authentication (required for payouts)
  password?: string;                 // Optional: Password for authentication (required for payouts)
  baseURL?: string;                  // Optional: API base URL
  errorHandling?: 'next' | 'direct'; // Optional: Legacy error handling mode (fallback)
  onError?: ErrorHandler;            // Optional: Global error handler (takes priority over errorHandling)
}
```

## Environment Variables Setup

```bash
# .env file
NOWPAYMENTS_API_KEY=your-api-key-here
NOWPAYMENTS_EMAIL=your-email@example.com
NOWPAYMENTS_PASSWORD=your-password
NOWPAYMENTS_BASE_URL=https://api.nowpayments.io/v1

# Development
NOWPAYMENTS_API_KEY_DEV=your-dev-api-key
NOWPAYMENTS_EMAIL_DEV=your-dev-email@example.com
NOWPAYMENTS_PASSWORD_DEV=your-dev-password

# Production
NOWPAYMENTS_API_KEY_PROD=your-prod-api-key
NOWPAYMENTS_EMAIL_PROD=your-prod-email@example.com
NOWPAYMENTS_PASSWORD_PROD=your-prod-password
```

## Advanced Configuration with Validation

```typescript
import { NowPaymentsMiddleware } from '@taloon/nowpayments-middleware';

class ConfigManager {
  static initialize() {
    const requiredEnvVars = ['NOWPAYMENTS_API_KEY'];
    const missingVars = requiredEnvVars.filter(varName => !process.env[varName]);
    
    if (missingVars.length > 0) {
      throw new Error(`Missing required environment variables: ${missingVars.join(', ')}`);
    }

    NowPaymentsMiddleware.configure({
      apiKey: process.env.NOWPAYMENTS_API_KEY!,
      email: process.env.NOWPAYMENTS_EMAIL,
      password: process.env.NOWPAYMENTS_PASSWORD,
      baseURL: process.env.NOWPAYMENTS_BASE_URL || 'https://api.nowpayments.io/v1',
      errorHandling: (process.env.NODE_ENV === 'production' ? 'next' : 'direct') as 'next' | 'direct',
    });

    console.log('âœ… NowPayments middleware configured successfully');
  }

  static getConfig() {
    return {
      apiKey: process.env.NOWPAYMENTS_API_KEY,
      hasBearer: !!process.env.NOWPAYMENTS_BEARER_TOKEN,
      environment: process.env.NODE_ENV || 'development',
      baseURL: process.env.NOWPAYMENTS_BASE_URL || 'https://api.nowpayments.io/v1',
    };
  }
}

// Initialize configuration
ConfigManager.initialize();
```

## Docker Environment Configuration

```dockerfile
# Dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .

# Environment variables for runtime
ENV NODE_ENV=production
ENV NOWPAYMENTS_BASE_URL=https://api.nowpayments.io/v1

EXPOSE 3000

CMD ["npm", "start"]
```

```yaml
# docker-compose.yml
version: '3.8'
services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - NOWPAYMENTS_API_KEY=${NOWPAYMENTS_API_KEY}
      - NOWPAYMENTS_EMAIL=${NOWPAYMENTS_EMAIL}
      - NOWPAYMENTS_PASSWORD=${NOWPAYMENTS_PASSWORD}
      - NOWPAYMENTS_BASE_URL=https://api.nowpayments.io/v1
    env_file:
      - .env.production
```

## Testing Configuration

```typescript
// test-config.ts
import { NowPaymentsMiddleware } from '@taloon/nowpayments-middleware';

export const setupTestConfig = () => {
  NowPaymentsMiddleware.configure({
    apiKey: 'test-api-key',
    email: 'test@example.com',
    password: 'test-password',
    baseURL: 'https://api-sandbox.nowpayments.io/v1',
    errorHandling: 'direct',
  });
};

// In your tests
beforeAll(() => {
  setupTestConfig();
});
```

## Configuration with Health Check

```typescript
import express from 'express';
import { NowPaymentsMiddleware } from '@taloon/nowpayments-middleware';

const app = express();

// Configuration
NowPaymentsMiddleware.configure({
  apiKey: process.env.NOWPAYMENTS_API_KEY!,
  email: process.env.NOWPAYMENTS_EMAIL,
  password: process.env.NOWPAYMENTS_PASSWORD,
  errorHandling: 'next',
});

// Health check endpoint
app.get('/health', (req, res) => {
  const config = {
    hasApiKey: !!process.env.NOWPAYMENTS_API_KEY,
    hasAuth: !!(process.env.NOWPAYMENTS_EMAIL && process.env.NOWPAYMENTS_PASSWORD),
    environment: process.env.NODE_ENV || 'development',
    timestamp: new Date().toISOString(),
  };

  res.json({
    status: 'ok',
    service: 'nowpayments-middleware',
    config,
  });
});

// Configuration validation endpoint
app.get('/config/validate', (req, res) => {
  try {
    const isValid = !!process.env.NOWPAYMENTS_API_KEY;
    
    res.json({
      valid: isValid,
      message: isValid ? 'Configuration is valid' : 'Missing required API key',
    });
  } catch (error) {
    res.status(500).json({
      valid: false,
      error: 'Configuration validation failed',
    });
  }
});
```
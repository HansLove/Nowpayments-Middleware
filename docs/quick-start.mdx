# NowPayments Middleware - Quick Start

Express middleware for NowPayments cryptocurrency payment integration with dependency injection support.

## Installation

```bash
npm install @taloon/nowpayments-middleware
```

## Basic Configuration

```typescript
import { NowPaymentsMiddleware } from '@taloon/nowpayments-middleware';

// Configure globally
NowPaymentsMiddleware.configure({
  apiKey: 'your-nowpayments-api-key',
  email: 'your-email@example.com', // Optional, required for payouts
  password: 'your-password', // Optional, required for payouts
  errorHandling: 'next', // or 'direct' (legacy)
  onError: async (error, req, res, next) => {
    // Optional: Global error handler (takes priority over errorHandling mode)
    if (error instanceof NowPaymentsError) {
      return res.status(error.statusCode || 500).json({
        success: false,
        error: {
          code: error.code,
          message: 'Payment service error',
        },
      });
    }
    next(error);
  },
});
```

## Environment Variables Setup

You can configure the middleware using environment variables. All are optional except `NOWPAYMENTS_API_KEY`:

```bash
# Required
NOWPAYMENTS_API_KEY=your-api-key

# Optional: Authentication for payouts
NOWPAYMENTS_EMAIL=your-email@example.com
NOWPAYMENTS_PASSWORD=your-password

# Optional: 2FA for automatic payout verification
NOWPAYMENTS_2FA_SECRET=your-base32-encoded-2fa-secret

# Optional: Custom API base URL
NOWPAYMENTS_BASE_URL=https://api.nowpayments.io/v1
```

**Variable Reference:**
- `NOWPAYMENTS_API_KEY` (required): API key from NowPayments dashboard
- `NOWPAYMENTS_EMAIL` (optional): Email for payout authentication
- `NOWPAYMENTS_PASSWORD` (optional): Password for payout authentication
- `NOWPAYMENTS_2FA_SECRET` (optional): Base32-encoded 2FA secret key for automatic payout verification
- `NOWPAYMENTS_BASE_URL` (optional): Custom API endpoint (default: `https://api.nowpayments.io/v1`)

## Simple Payment Creation

```typescript
import express from 'express';

const app = express();
app.use(express.json());

app.post('/create-payment',
  NowPaymentsMiddleware.createPayment({
    mapRequest: (req, res) => ({
      price_amount: req.body.amount,
      price_currency: req.body.currency,
      pay_currency: req.body.cryptoCurrency,
      order_id: req.body.orderId,
      customer_email: req.body.email,
      ipn_callback_url: 'https://your-domain.com/webhook/payment',
    }),
    transformResponse: (response) => ({
      paymentId: response.payment_id,
      status: response.payment_status,
      payAddress: response.pay_address,
      amount: response.pay_amount,
      currency: response.pay_currency,
    }),
    onError: async (error, req, res, next) => {
      // Optional: Per-middleware error handler (overrides global handler)
      console.error('Payment creation error:', error);

      if (error instanceof NowPaymentsValidationError) {
        return res.status(400).json({
          success: false,
          error: { message: error.message },
        });
      }

      res.status(500).json({
        success: false,
        error: { message: 'Payment creation failed' },
      });
    },
  }),
  (req, res) => {
    const payment = res.locals.nowPaymentsResponse;
    res.json({ success: true, payment });
  }
);
```

## Basic Webhook Handler

```typescript
app.post('/webhook/payment',
  NowPaymentsMiddleware.paymentWebhook({
    onWaiting: async (payload) => {
      console.log('Payment waiting:', payload.payment_id);
    },
    onFinished: async (payload) => {
      console.log('Payment completed:', payload.payment_id);
      // Update your database, send notifications, etc.
    },
    onFailed: async (payload) => {
      console.log('Payment failed:', payload.payment_id);
      // Handle failed payment
    },
  })
);
```

## Error Handling

```typescript
app.use((error, req, res, next) => {
  if (error instanceof NowPaymentsError) {
    return res.status(error.statusCode || 400).json({
      error: {
        code: error.code,
        message: error.message,
      },
    });
  }
  
  res.status(500).json({
    error: { code: 'INTERNAL_ERROR', message: 'An unexpected error occurred' }
  });
});
```